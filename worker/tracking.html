<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Application Tracking - Worker</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .tracking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
    .stat-card{background:var(--glass-bg);padding:20px;border-radius:var(--radius);text-align:center}
    .stat-number{font-size:2.5rem;font-weight:900;color:var(--primary);margin-bottom:5px}
    .stat-label{color:var(--text-muted);font-size:14px}
    .tracking-timeline{margin-top:20px}
    .timeline-item{display:flex;gap:15px;margin-bottom:20px;position:relative}
    .timeline-item::before{content:'';position:absolute;left:20px;top:40px;bottom:-20px;width:2px;background:#ddd}
    .timeline-item:last-child::before{display:none}
    .timeline-date{min-width:80px;text-align:right;color:var(--text-muted);font-size:12px}
    .timeline-content{flex:1}
    .timeline-dot{width:12px;height:12px;border-radius:50%;background:var(--accent-orange);margin-top:5px;flex-shrink:0}
    .timeline-dot.completed{background:var(--action-green)}
    .timeline-dot.pending{background:var(--accent-orange)}
    .timeline-dot.rejected{background:#dc3545}
    .job-card{background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid var(--primary)}
    .job-title{font-weight:bold;margin-bottom:5px}
    .job-meta{font-size:14px;color:var(--text-muted);margin-bottom:10px}
    .status-badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;display:inline-block}
    .status-applied{background:var(--accent-orange);color:white}
    .status-viewed{background:#17a2b8;color:white}
    .status-interview{background:#6f42c1;color:white}
    .status-offered{background:#28a745;color:white}
    .status-rejected{background:#dc3545;color:white}
    .calendar-widget{background:white;padding:15px;border-radius:8px;margin-top:20px}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
    .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:4px;font-size:12px;cursor:pointer}
    .calendar-day.has-event{background:var(--accent-orange);color:white;font-weight:bold}
    .calendar-day.today{background:var(--primary);color:white}
    .reminder-card{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:8px;margin-top:10px}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="home.html" class="btn">‚Üê Back</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Application Tracking</h1>
    <p class="meta mb-2">Monitor your job applications and interview schedule</p>

    <!-- Statistics Overview -->
    <div class="tracking-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalApplications">0</div>
        <div class="stat-label">Total Applications</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingApplications">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="interviewCount">0</div>
        <div class="stat-label">Interviews Scheduled</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="offerCount">0</div>
        <div class="stat-label">Job Offers</div>
      </div>
    </div>

    <!-- Application Timeline -->
    <div class="card tracking-timeline">
      <h2 style="margin:0 0 20px;">Application Timeline</h2>
      <div id="timelineContainer">
        <p class="meta">Loading application history...</p>
      </div>
    </div>

    <!-- Upcoming Interviews -->
    <div class="card" style="margin-top:20px;">
      <h2 style="margin:0 0 15px;">Upcoming Interviews</h2>
      <div id="interviewList">
        <p class="meta">No interviews scheduled</p>
      </div>
    </div>

    <!-- Interview Calendar -->
    <div class="card calendar-widget">
      <div class="calendar-header">
        <h3 style="margin:0;">Interview Calendar</h3>
        <div>
          <button class="btn" onclick="previousMonth()">‚Üê</button>
          <span id="currentMonth" style="margin:0 10px;font-weight:bold;"></span>
          <button class="btn" onclick="nextMonth()">‚Üí</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be generated here -->
      </div>
      <div id="calendarEvents" style="margin-top:15px;">
        <!-- Events for selected date -->
      </div>
    </div>

    <!-- Application Templates -->
    <div class="card" style="margin-top:20px;">
      <h2 style="margin:0 0 15px;">Application Templates</h2>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="createTemplate()">+ Create Template</button>
        <select id="templateSelect" style="padding:8px;border:1px solid #ddd;border-radius:8px;">
          <option value="">Select template...</option>
          <option value="cover1">Professional Cover Letter</option>
          <option value="cover2">Enthusiastic Application</option>
          <option value="cover3">Experienced Worker</option>
        </select>
      </div>
      <div id="templatePreview" style="margin-top:15px;display:none;">
        <h4>Template Preview:</h4>
        <div id="templateContent" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px;"></div>
      </div>
    </div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    (function () {
      const user = getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      if (user.role !== "worker") {
        alert("Worker access only.");
        window.location.href = "../index.html";
        return;
      }

      document.getElementById("logoutBtn").addEventListener("click", logout);

      let currentDate = new Date();
      let applications = [];
      let interviews = [];

      function esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[m]);
      }

      function formatDate(date) {
        return new Date(date).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
      }

      function getStatusBadge(status) {
        const statusMap = {
          'applied': 'status-applied',
          'viewed': 'status-viewed',
          'interview': 'status-interview',
          'offered': 'status-offered',
          'rejected': 'status-rejected'
        };
        const statusClass = statusMap[status] || 'status-applied';
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
      }

      function timelineItem(application) {
        const isCompleted = ['offered', 'rejected'].includes(application.status);
        const dotClass = isCompleted ? 'completed' : (application.status === 'interview' ? 'pending' : 'pending');
        
        return `
          <div class="timeline-item">
            <div class="timeline-dot ${dotClass}"></div>
            <div class="timeline-date">${formatDate(application.applied_at)}</div>
            <div class="timeline-content">
              <div class="job-card">
                <div class="job-title">${esc(application.job_title)}</div>
                <div class="job-meta">${esc(application.company)} ‚Ä¢ ${esc(application.location)}</div>
                <div class="job-meta">Applied: ${formatDate(application.applied_at)}</div>
                <div>${getStatusBadge(application.status)}</div>
                ${application.notes ? `<div style="margin-top:10px;font-size:14px;"><strong>Notes:</strong> ${esc(application.notes)}</div>` : ''}
              </div>
            </div>
          </div>
        `;
      }

      function interviewCard(interview) {
        return `
          <div class="card" style="padding:15px;margin-bottom:10px;border-left:4px solid var(--action-green);">
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div>
                <div style="font-weight:bold;margin-bottom:5px;">${esc(interview.job_title)}</div>
                <div class="meta">${esc(interview.company)}</div>
                <div class="meta">üìÖ ${formatDate(interview.date)} at ${interview.time}</div>
                <div class="meta">üìç ${esc(interview.location || 'Remote')}</div>
              </div>
              <div>
                ${getStatusBadge('interview')}
                <button class="btn" style="margin-top:10px;" onclick="addToCalendar(${interview.id})">Add to Calendar</button>
              </div>
            </div>
          </div>
        `;
      }

      function generateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        document.getElementById('currentMonth').textContent = 
          new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        let calendarHTML = '';
        
        // Day headers
        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
          calendarHTML += `<div style="font-weight:bold;text-align:center;font-size:12px;">${day}</div>`;
        });
        
        // Empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          calendarHTML += '<div></div>';
        }
        
        // Days of the month
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const isToday = date.toDateString() === today.toDateString();
          const hasEvent = interviews.some(interview => {
            const interviewDate = new Date(interview.date);
            return interviewDate.toDateString() === date.toDateString();
          });
          
          calendarHTML += `
            <div class="calendar-day ${isToday ? 'today' : ''} ${hasEvent ? 'has-event' : ''}" 
                 onclick="selectDate(${year}, ${month}, ${day})">
              ${day}
            </div>
          `;
        }
        
        document.getElementById('calendarGrid').innerHTML = calendarHTML;
      }

      function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar();
      }

      function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar();
      }

      function selectDate(year, month, day) {
        const selectedDate = new Date(year, month, day);
        const dayEvents = interviews.filter(interview => {
          const interviewDate = new Date(interview.date);
          return interviewDate.toDateString() === selectedDate.toDateString();
        });
        
        const eventsContainer = document.getElementById('calendarEvents');
        if (dayEvents.length === 0) {
          eventsContainer.innerHTML = '<p class="meta">No events on this date</p>';
        } else {
          eventsContainer.innerHTML = dayEvents.map(event => `
            <div class="reminder-card">
              <strong>${esc(event.job_title)}</strong><br>
              ${esc(event.company)} ‚Ä¢ ${event.time}
            </div>
          `).join('');
        }
      }

      function loadApplications() {
        // Mock application data
        applications = [
          {
            id: 1,
            job_title: 'Security Guard',
            company: 'ABC Security',
            location: 'Mumbai',
            status: 'interview',
            applied_at: new Date(Date.now() - 86400000 * 5).toISOString(),
            notes: 'Interview scheduled for tomorrow'
          },
          {
            id: 2,
            job_title: 'Driver',
            company: 'XYZ Transport',
            location: 'Delhi',
            status: 'viewed',
            applied_at: new Date(Date.now() - 86400000 * 3).toISOString(),
            notes: 'Application viewed by recruiter'
          },
          {
            id: 3,
            job_title: 'Cook',
            company: 'Food Court',
            location: 'Bangalore',
            status: 'applied',
            applied_at: new Date(Date.now() - 86400000 * 1).toISOString(),
            notes: 'Recently applied'
          }
        ];

        // Update statistics
        document.getElementById('totalApplications').textContent = applications.length;
        document.getElementById('pendingApplications').textContent = 
          applications.filter(app => app.status === 'applied' || app.status === 'viewed').length;
        document.getElementById('interviewCount').textContent = 
          applications.filter(app => app.status === 'interview').length;
        document.getElementById('offerCount').textContent = 
          applications.filter(app => app.status === 'offered').length;

        // Generate timeline
        const timelineContainer = document.getElementById('timelineContainer');
        if (applications.length === 0) {
          timelineContainer.innerHTML = '<p class="meta">No applications yet. Start applying to jobs!</p>';
        } else {
          timelineContainer.innerHTML = applications
            .sort((a, b) => new Date(b.applied_at) - new Date(a.applied_at))
            .map(timelineItem).join('');
        }
      }

      function loadInterviews() {
        // Mock interview data
        interviews = [
          {
            id: 1,
            job_title: 'Security Guard',
            company: 'ABC Security',
            date: new Date(Date.now() + 86400000).toISOString(),
            time: '10:00 AM',
            location: 'Office - Andheri'
          },
          {
            id: 2,
            job_title: 'Driver',
            company: 'XYZ Transport',
            date: new Date(Date.now() + 86400000 * 2).toISOString(),
            time: '2:00 PM',
            location: 'Remote - Video Call'
          }
        ];

        const interviewList = document.getElementById('interviewList');
        if (interviews.length === 0) {
          interviewList.innerHTML = '<p class="meta">No interviews scheduled</p>';
        } else {
          interviewList.innerHTML = interviews.map(interviewCard).join('');
        }
      }

      function createTemplate() {
        alert('Template creation feature coming soon! You can save custom cover letters and application messages.');
      }

      function addToCalendar(interviewId) {
        const interview = interviews.find(i => i.id === interviewId);
        if (interview) {
          alert(`Interview added to calendar:\n${interview.job_title}\n${formatDate(interview.date)} at ${interview.time}`);
        }
      }

      // Template selection
      document.getElementById('templateSelect').addEventListener('change', function() {
        const templateId = this.value;
        const preview = document.getElementById('templatePreview');
        const content = document.getElementById('templateContent');
        
        if (templateId) {
          const templates = {
            cover1: 'Dear Hiring Manager,\n\nI am writing to express my interest in the [Job Title] position at [Company Name]. With my [X years] of experience in [relevant field], I am confident in my ability to contribute effectively to your team.\n\nThank you for considering my application.\n\nSincerely,\n[Your Name]',
            cover2: 'Hello!\n\nI am excited about the opportunity to apply for the [Job Title] role at [Company Name]. I believe my skills and enthusiasm make me a great fit for this position.\n\nI look forward to discussing how I can help your team succeed.\n\nBest regards,\n[Your Name]',
            cover3: 'To the Recruitment Team,\n\nI am applying for the [Job Title] position with [X years] of professional experience. My background in [specific skills] aligns perfectly with your requirements.\n\nI am eager to bring my expertise to your organization.\n\nRegards,\n[Your Name]'
          };
          
          content.textContent = templates[templateId] || '';
          preview.style.display = 'block';
        } else {
          preview.style.display = 'none';
        }
      });

      // Initialize
      loadApplications();
      loadInterviews();
      generateCalendar();
    })();
  </script>

  <div data-include="footer"></div>
</body>
</html>
