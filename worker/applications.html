<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Applications - Worker</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .app-card{padding:16px}
    .app-title{font-size:20px;font-weight:900;margin:0 0 8px}
    .app-meta{margin:6px 0}
    .status-badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold}
    .status-pending{background:var(--accent-orange);color:white}
    .status-accepted{background:var(--action-green);color:white}
    .status-rejected{background:#dc3545;color:white}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="home.html" class="btn">‚Üê Back</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">My Applications</h1>
    <p class="meta mb-2">Track all your job applications</p>

    <div id="applicationsList" class="grid" style="margin-top:14px;">
      <p class="meta">Loading your applications...</p>
    </div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    (function () {
      const user = getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      if (user.role !== "worker") {
        alert("Worker access only.");
        window.location.href = "../index.html";
        return;
      }

      document.getElementById("logoutBtn").addEventListener("click", logout);

      function esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[m]);
      }

      function getStatusBadge(status) {
        const statusClass = status === 'pending' ? 'status-pending' : 
                           status === 'accepted' ? 'status-accepted' : 'status-rejected';
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
      }

      function applicationCard(app) {
        const appliedDate = new Date(app.applied_at).toLocaleDateString();
        
        return `
          <div class="card app-card">
            <div class="app-title">${esc(app.job ? app.job.title : 'Unknown Job')}</div>
            <div class="app-meta"><strong>Company:</strong> ${esc(app.job ? app.job.company : 'Unknown')}</div>
            <div class="app-meta"><strong>Location:</strong> ${esc(app.job ? app.job.location : 'Unknown')}</div>
            <div class="app-meta"><strong>Applied:</strong> ${appliedDate}</div>
            <div class="app-meta"><strong>Status:</strong> ${getStatusBadge(app.status)}</div>
            ${app.message ? `<div class="app-meta"><strong>Your Message:</strong> ${esc(app.message)}</div>` : ''}
            <div style="margin-top:12px;">
              <a class="btn btn-primary" href="job-details.html?id=${app.job_id}">View Job</a>
            </div>
          </div>
        `;
      }

      async function loadApplications() {
        const listElement = document.getElementById("applicationsList");
        
        try {
          const response = await fetch(API("applications_list.php") + `?user_id=${encodeURIComponent(user.id)}`);
          const data = await response.json();

          if (!data.ok) {
            listElement.innerHTML = `<p class="meta">Failed to load applications.</p>`;
            return;
          }

          const applications = data.applications || [];
          
          if (applications.length === 0) {
            listElement.innerHTML = `
              <div class="card" style="padding:20px;text-align:center;">
                <p class="meta">You haven't applied to any jobs yet.</p>
                <a href="home.html" class="btn btn-primary" style="margin-top:10px;">Browse Jobs</a>
              </div>
            `;
            return;
          }

          listElement.innerHTML = applications.map(applicationCard).join("");
          
        } catch (error) {
          console.error('Error loading applications:', error);
          listElement.innerHTML = `<p class="meta">Server error. Please try again.</p>`;
        }
      }

      loadApplications();
    })();
  </script>

  <div data-include="footer"></div>
</body>
</html>
