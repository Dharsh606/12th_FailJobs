<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Communication Tools - Recruiter</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .comm-grid{display:grid;grid-template-columns:1fr 2fr;gap:20px;margin-top:20px}
    .sidebar{display:flex;flex-direction:column;gap:15px}
    .main-content{display:flex;flex-direction:column;gap:20px}
    .conversation-list{max-height:500px;overflow-y:auto}
    .conversation-item{background:white;padding:15px;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all 0.3s}
    .conversation-item:hover{transform:translateX(5px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .conversation-item.active{border-left:4px solid var(--accent-orange);background:var(--glass-bg)}
    .candidate-name{font-weight:bold;margin-bottom:5px}
    .last-message{color:var(--text-muted);font-size:14px;margin-bottom:8px}
    .message-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted)}
    .chat-container{background:white;border-radius:8px;height:500px;display:flex;flex-direction:column}
    .chat-header{background:var(--primary);color:white;padding:15px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center}
    .chat-messages{flex:1;overflow-y:auto;padding:15px;background:#f8f9fa}
    .chat-input{padding:15px;border-top:1px solid #eee;display:flex;gap:10px}
    .chat-input input{flex:1;padding:10px;border:1px solid #ddd;border-radius:20px}
    .chat-input button{background:var(--accent-orange);color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer}
    .message-bubble{margin-bottom:15px;display:flex;flex-direction:column}
    .message-bubble.sent{align-items:flex-end}
    .message-bubble.received{align-items:flex-start}
    .bubble-content{max-width:70%;padding:10px 15px;border-radius:18px;word-wrap:break-word}
    .message-bubble.sent .bubble-content{background:var(--accent-orange);color:white;border-bottom-right-radius:4px}
    .message-bubble.received .bubble-content{background:white;border:1px solid #eee;border-bottom-left-radius:4px}
    .message-time{font-size:11px;color:var(--text-muted);margin-top:5px}
    .bulk-actions{background:white;padding:15px;border-radius:8px}
    .template-list{max-height:200px;overflow-y:auto}
    .template-item{padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:8px;cursor:pointer}
    .template-item:hover{background:var(--glass-bg)}
    .template-title{font-weight:bold;margin-bottom:5px}
    .template-preview{font-size:12px;color:var(--text-muted)}
    .interview-scheduler{background:white;padding:15px;border-radius:8px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:10px}
    .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:1px solid #ddd;border-radius:4px;font-size:12px;cursor:pointer}
    .calendar-day.available{background:var(--action-green);color:white}
    .calendar-day.selected{background:var(--accent-orange);color:white}
    .time-slots{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:15px}
    .time-slot{padding:8px;border:1px solid #ddd;border-radius:6px;text-align:center;cursor:pointer}
    .time-slot:hover{background:var(--glass-bg)}
    .notification-badge{background:var(--action-green);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;position:absolute;top:10px;right:10px}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="dashboard.html" class="btn">‚Üê Back</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Communication Tools</h1>
    <p class="meta mb-2">Message candidates, schedule interviews, and manage recruitment communications</p>

    <div class="comm-grid">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Quick Actions -->
        <div class="bulk-actions">
          <h3 style="margin:0 0 15px;">Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn btn-primary" onclick="bulkMessage()">üìß Send Bulk Message</button>
            <button class="btn" onclick="scheduleInterviews()">üìÖ Schedule Interviews</button>
            <button class="btn" onclick="viewTemplates()">üìù Message Templates</button>
            <button class="btn" onclick="autoRespond()">ü§ñ Auto-Respond</button>
          </div>
        </div>

        <!-- Message Templates -->
        <div class="card">
          <h3 style="margin:0 0 15px;">Message Templates</h3>
          <div class="template-list">
            <div class="template-item" onclick="useTemplate('interview')">
              <div class="template-title">Interview Invitation</div>
              <div class="template-preview">Thank you for applying. We'd like to schedule an interview...</div>
            </div>
            <div class="template-item" onclick="useTemplate('rejection')">
              <div class="template-title">Polite Rejection</div>
              <div class="template-preview">Thank you for your interest. We've decided to move forward...</div>
            </div>
            <div class="template-item" onclick="useTemplate('offer')">
              <div class="template-title">Job Offer</div>
              <div class="template-preview">We're pleased to offer you the position of...</div>
            </div>
            <div class="template-item" onclick="useTemplate('followup')">
              <div class="template-title">Follow-up</div>
              <div class="template-preview">Just following up on your application for...</div>
            </div>
          </div>
          <button class="btn btn-primary" style="margin-top:10px;width:100%;" onclick="createTemplate()">+ Create Template</button>
        </div>

        <!-- Communication Stats -->
        <div class="card">
          <h3 style="margin:0 0 15px;">Communication Stats</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;">
              <span>Messages Sent:</span>
              <strong>156</strong>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Response Rate:</span>
              <strong>78%</strong>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Interviews Scheduled:</span>
              <strong>23</strong>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Pending Replies:</span>
              <strong>12</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Conversations List -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="margin:0;">Active Conversations</h3>
            <div style="display:flex;gap:10px;">
              <input type="text" placeholder="Search conversations..." style="padding:8px;border:1px solid #ddd;border-radius:6px;">
              <select style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                <option>All Candidates</option>
                <option>Unread Messages</option>
                <option>Interview Scheduled</option>
                <option>Application Received</option>
              </select>
            </div>
          </div>
          
          <div class="conversation-list" id="conversationList">
            <p class="meta">Loading conversations...</p>
          </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container" id="chatContainer" style="display:none;">
          <div class="chat-header">
            <div>
              <div id="chatCandidateName" style="font-weight:bold;">Candidate Name</div>
              <div id="chatJobTitle" style="font-size:12px;opacity:0.8;">Job Title</div>
            </div>
            <div style="display:flex;gap:10px;">
              <button onclick="scheduleInterviewWithCandidate()" style="background:white;color:var(--primary);border:1px solid var(--primary);padding:6px 12px;border-radius:6px;cursor:pointer;">üìÖ Schedule</button>
              <button onclick="viewCandidateProfile()" style="background:white;color:var(--primary);border:1px solid var(--primary);padding:6px 12px;border-radius:6px;cursor:pointer;">üë§ Profile</button>
              <button onclick="closeChat()" style="background:none;border:none;font-size:20px;cursor:pointer;">√ó</button>
            </div>
          </div>
          
          <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
          </div>
          
          <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
          </div>
        </div>

        <!-- Interview Scheduler -->
        <div class="interview-scheduler" id="interviewScheduler" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 style="margin:0;">Schedule Interview</h3>
            <button onclick="closeScheduler()" style="background:none;border:none;font-size:20px;cursor:pointer;">√ó</button>
          </div>
          
          <div style="display:flex;gap:20px;">
            <div style="flex:1;">
              <label style="display:block;margin-bottom:5px;font-weight:bold;">Select Date:</label>
              <input type="date" id="interviewDate" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
            </div>
            <div style="flex:1;">
              <label style="display:block;margin-bottom:5px;font-weight:bold;">Available Time Slots:</label>
              <div class="time-slots">
                <div class="time-slot" onclick="selectTime('09:00')">09:00 AM</div>
                <div class="time-slot" onclick="selectTime('10:00')">10:00 AM</div>
                <div class="time-slot" onclick="selectTime('11:00')">11:00 AM</div>
                <div class="time-slot" onclick="selectTime('14:00')">02:00 PM</div>
                <div class="time-slot" onclick="selectTime('15:00')">03:00 PM</div>
                <div class="time-slot" onclick="selectTime('16:00')">04:00 PM</div>
                <div class="time-slot" onclick="selectTime('17:00')">05:00 PM</div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:bold;">Interview Type:</label>
            <select id="interviewType" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
              <option>In-Person Interview</option>
              <option>Video Call</option>
              <option>Phone Interview</option>
            </select>
          </div>
          
          <div style="margin-top:15px;">
            <label style="display:block;margin-bottom:5px;font-weight:bold;">Additional Notes:</label>
            <textarea id="interviewNotes" placeholder="Any special instructions for the candidate..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;min-height:80px;resize:vertical;"></textarea>
          </div>
          
          <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn" onclick="closeScheduler()">Cancel</button>
            <button class="btn btn-primary" onclick="sendInterviewInvitation()">Send Invitation</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    (function () {
      const user = getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      if (user.role !== "recruiter") {
        alert("Recruiter access only.");
        window.location.href = "../index.html";
        return;
      }

      document.getElementById("logoutBtn").addEventListener("click", logout);

      let currentChat = null;
      let conversations = [];

      function esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[m]);
      }

      function formatTime(date) {
        return new Date(date).toLocaleString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      }

      function conversationItem(conversation) {
        const unreadCount = conversation.unread_count || 0;
        
        return `
          <div class="conversation-item ${currentChat && currentChat.id === conversation.id ? 'active' : ''}" 
               onclick="openChat(${conversation.id}, '${esc(conversation.candidate_name)}', '${esc(conversation.job_title)}')">
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div>
                <div class="candidate-name">${esc(conversation.candidate_name)}</div>
                <div class="last-message">${esc(conversation.last_message)}</div>
                <div class="message-meta">
                  <span>${formatTime(conversation.last_message_time)}</span>
                  ${conversation.job_title ? `‚Ä¢ ${esc(conversation.job_title)}` : ''}
                </div>
              </div>
              <div style="text-align:right;">
                ${unreadCount > 0 ? `<div class="notification-badge">${unreadCount}</div>` : ''}
              </div>
            </div>
          </div>
        `;
      }

      function messageBubble(message, isSent) {
        return `
          <div class="message-bubble ${isSent ? 'sent' : 'received'}">
            <div class="bubble-content">${esc(message.content)}</div>
            <div class="message-time">${formatTime(message.timestamp)}</div>
          </div>
        `;
      }

      function openChat(conversationId, candidateName, jobTitle) {
        currentChat = { id: conversationId, name: candidateName, job: jobTitle };
        
        const chatContainer = document.getElementById('chatContainer');
        const schedulerContainer = document.getElementById('interviewScheduler');
        const chatMessages = document.getElementById('chatMessages');
        const chatCandidateName = document.getElementById('chatCandidateName');
        const chatJobTitle = document.getElementById('chatJobTitle');
        
        chatContainer.style.display = 'flex';
        schedulerContainer.style.display = 'none';
        chatCandidateName.textContent = candidateName;
        chatJobTitle.textContent = jobTitle;
        chatMessages.innerHTML = '<p class="meta">Loading conversation...</p>';
        
        loadChatMessages(conversationId);
      }

      function closeChat() {
        document.getElementById('chatContainer').style.display = 'none';
        currentChat = null;
      }

      function loadChatMessages(conversationId) {
        const chatMessages = document.getElementById('chatMessages');
        
        // Mock chat messages
        const mockMessages = [
          { 
            content: 'Hi! I applied for the Security Guard position.',
            timestamp: new Date(Date.now() - 3600000).toISOString(),
            sender: 'candidate'
          },
          { 
            content: 'Thank you for your application! We\'d like to schedule an interview.',
            timestamp: new Date(Date.now() - 1800000).toISOString(),
            sender: 'recruiter'
          },
          { 
            content: 'That sounds great! When would be a good time?',
            timestamp: new Date(Date.now() - 900000).toISOString(),
            sender: 'candidate'
          }
        ];

        chatMessages.innerHTML = mockMessages.map(msg => 
          messageBubble(msg, msg.sender === 'recruiter')
        ).join('');
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || !currentChat) return;
        
        const chatMessages = document.getElementById('chatMessages');
        const messageHtml = messageBubble({
          content: message,
          timestamp: new Date().toISOString(),
          sender: 'recruiter'
        }, true);
        
        chatMessages.innerHTML += messageHtml;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        input.value = '';
        
        // Simulate sending to server
        console.log('Sending message:', { 
          conversationId: currentChat.id, 
          message: message 
        });
      }

      function bulkMessage() {
        alert('Bulk Messaging Feature:\n\n1. Select multiple candidates\n2. Choose message template\n3. Send personalized messages\n4. Track responses\n\nThis helps reach multiple candidates efficiently.');
      }

      function scheduleInterviews() {
        document.getElementById('chatContainer').style.display = 'none';
        document.getElementById('interviewScheduler').style.display = 'block';
      }

      function closeScheduler() {
        document.getElementById('interviewScheduler').style.display = 'none';
      }

      function selectTime(time) {
        document.querySelectorAll('.time-slot').forEach(slot => {
          slot.classList.remove('selected');
        });
        event.target.classList.add('selected');
      }

      function sendInterviewInvitation() {
        const date = document.getElementById('interviewDate').value;
        const selectedTime = document.querySelector('.time-slot.selected');
        const type = document.getElementById('interviewType').value;
        const notes = document.getElementById('interviewNotes').value;
        
        if (!date || !selectedTime) {
          alert('Please select both date and time for the interview.');
          return;
        }
        
        alert(`Interview invitation sent!\n\nDate: ${date}\nTime: ${selectedTime.textContent}\nType: ${type}\n\nCandidate will receive notification with calendar invite.`);
        closeScheduler();
      }

      function scheduleInterviewWithCandidate() {
        if (currentChat) {
          scheduleInterviews();
        }
      }

      function viewCandidateProfile() {
        if (currentChat) {
          alert(`Viewing full profile for: ${currentChat.name}\n\nThis would show complete candidate information, resume, and application history.`);
        }
      }

      function useTemplate(templateType) {
        const templates = {
          interview: 'Thank you for your application. We would like to schedule an interview to discuss your qualifications further. Please let us know your availability.',
          rejection: 'Thank you for your interest in the position. After careful consideration, we have decided to move forward with other candidates whose qualifications more closely match our requirements.',
          offer: 'We are pleased to offer you the position! We were impressed with your qualifications and believe you would be a great addition to our team.',
          followup: 'Just following up on your application. We wanted to see if you have any questions about the position or if you need any additional information.'
        };
        
        const template = templates[templateType];
        if (template && currentChat) {
          document.getElementById('messageInput').value = template;
          document.getElementById('messageInput').focus();
        }
      }

      function createTemplate() {
        alert('Create custom message template:\n\nSave frequently used messages for quick communication with candidates.');
      }

      function autoRespond() {
        alert('Auto-Respond Feature:\n\n‚Ä¢ Automatically respond to common questions\n‚Ä¢ Set up intelligent replies for FAQs\n‚Ä¢ Save time on repetitive communications\n‚Ä¢ Maintain consistent messaging tone');
      }

      function viewTemplates() {
        alert('Message Templates Manager:\n\n‚Ä¢ Edit existing templates\n‚Ä¢ Create new templates\n‚Ä¢ Organize by category\n‚Ä¢ Set default responses');
      }

      function loadConversations() {
        // Mock conversation data
        conversations = [
          {
            id: 1,
            candidate_name: 'Rahul Kumar',
            job_title: 'Security Guard',
            last_message: 'Thank you for the opportunity! I am available for interview.',
            last_message_time: new Date(Date.now() - 3600000).toISOString(),
            unread_count: 2
          },
          {
            id: 2,
            candidate_name: 'Priya Sharma',
            job_title: 'Driver',
            last_message: 'I have 5 years of experience in transportation...',
            last_message_time: new Date(Date.now() - 7200000).toISOString(),
            unread_count: 0
          },
          {
            id: 3,
            candidate_name: 'Amit Singh',
            job_title: 'Cook Assistant',
            last_message: 'When can I expect to hear back about the application?',
            last_message_time: new Date(Date.now() - 10800000).toISOString(),
            unread_count: 1
          }
        ];

        const conversationList = document.getElementById('conversationList');
        if (conversations.length === 0) {
          conversationList.innerHTML = '<p class="meta">No conversations yet.</p>';
        } else {
          conversationList.innerHTML = conversations.map(conversationItem).join('');
        }
      }

      // Message input enter key handler
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Initialize
      loadConversations();
    })();
  </script>

  <div data-include="footer"></div>
</body>
</html>
