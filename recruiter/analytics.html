<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics Dashboard - Recruiter</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:20px}
    .metric-card{background:var(--glass-bg);padding:20px;border-radius:var(--radius);text-align:center;position:relative}
    .metric-value{font-size:2.5rem;font-weight:900;color:var(--primary);margin-bottom:5px}
    .metric-label{font-size:14px;color:var(--text-muted)}
    .metric-change{position:absolute;top:20px;right:20px;font-size:12px;padding:4px 8px;border-radius:12px}
    .metric-up{background:var(--action-green);color:white}
    .metric-down{background:#dc3545;color:white}
    .chart-container{background:white;padding:20px;border-radius:8px;margin-top:20px}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .chart-title{font-size:18px;font-weight:bold}
    .chart-period{display:flex;gap:10px}
    .period-btn{padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:white;cursor:pointer}
    .period-btn.active{background:var(--primary);color:white}
    .chart-area{height:300px;position:relative}
    .funnel-chart{display:flex;align-items:center;gap:10px;height:300px}
    .funnel-stage{flex:1;text-align:center;padding:15px;border-radius:8px 8px 0 0;position:relative}
    .funnel-stage:nth-child(1){background:var(--primary);color:white;height:100%}
    .funnel-stage:nth-child(2){background:var(--accent-orange);color:white;height:80%}
    .funnel-stage:nth-child(3){background:#28a745;color:white;height:60%}
    .funnel-stage:nth-child(4){background:#6c757d;color:white;height:40%}
    .funnel-number{font-size:1.5rem;font-weight:900;margin-bottom:5px}
    .funnel-label{font-size:12px}
    .conversion-rate{position:absolute;bottom:10px;right:10px;font-size:11px;background:rgba(0,0,0,0.1);padding:4px 8px;border-radius:4px}
    .table-container{background:white;padding:20px;border-radius:8px;margin-top:20px}
    .analytics-table{width:100%;border-collapse:collapse}
    .analytics-table th{background:var(--glass-bg);padding:10px;text-align:left;font-weight:bold}
    .analytics-table td{padding:10px;border-bottom:1px solid #eee}
    .analytics-table tr:hover{background:#f8f9fa}
    .progress-bar{height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-top:5px}
    .progress-fill{height:100%;background:var(--action-green);transition:width 0.3s}
    .source-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .source-item{display:flex;align-items:center;gap:10px;padding:10px;background:#f8f9fa;border-radius:6px}
    .source-color{width:12px;height:12px;border-radius:50%}
    .source-info{flex:1}
    .source-name{font-weight:bold}
    .source-count{color:var(--text-muted);font-size:12px}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="dashboard.html" class="btn">← Back</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Analytics Dashboard</h1>
    <p class="meta mb-2">Track hiring metrics, job performance, and recruitment ROI</p>

    <!-- Key Metrics -->
    <div class="analytics-grid">
      <div class="metric-card">
        <div class="metric-value" id="totalViews">0</div>
        <div class="metric-label">Total Job Views</div>
        <div class="metric-change metric-up">+12.5%</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="totalApplications">0</div>
        <div class="metric-label">Total Applications</div>
        <div class="metric-change metric-up">+8.3%</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="conversionRate">0%</div>
        <div class="metric-label">Application Rate</div>
        <div class="metric-change metric-down">-2.1%</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="timeToHire">0d</div>
        <div class="metric-label">Avg. Time to Hire</div>
        <div class="metric-change metric-up">+5.2%</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="costPerHire">₹0</div>
        <div class="metric-label">Cost per Hire</div>
        <div class="metric-change metric-up">+3.7%</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="activeJobs">0</div>
        <div class="metric-label">Active Jobs</div>
        <div class="metric-change metric-up">+2</div>
      </div>
    </div>

    <!-- Application Funnel -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Application Funnel</div>
        <div class="chart-period">
          <button class="period-btn active">7 Days</button>
          <button class="period-btn">30 Days</button>
          <button class="period-btn">90 Days</button>
        </div>
      </div>
      <div class="funnel-chart">
        <div class="funnel-stage">
          <div class="funnel-number">2,847</div>
          <div class="funnel-label">Job Views</div>
          <div class="conversion-rate">100%</div>
        </div>
        <div class="funnel-stage">
          <div class="funnel-number">342</div>
          <div class="funnel-label">Applications</div>
          <div class="conversion-rate">12.0%</div>
        </div>
        <div class="funnel-stage">
          <div class="funnel-number">89</div>
          <div class="funnel-label">Interviews</div>
          <div class="conversion-rate">26.0%</div>
        </div>
        <div class="funnel-stage">
          <div class="funnel-number">23</div>
          <div class="funnel-label">Hires</div>
          <div class="conversion-rate">25.8%</div>
        </div>
      </div>
    </div>

    <!-- Job Performance Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Job Performance</div>
        <div class="chart-period">
          <button class="period-btn active">This Month</button>
          <button class="period-btn">Last Month</button>
          <button class="period-btn">3 Months</button>
        </div>
      </div>
      <div class="chart-area" id="performanceChart">
        <canvas id="jobChart" width="400" height="300"></canvas>
      </div>
    </div>

    <!-- Candidate Sources -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Candidate Sources</div>
      </div>
      <div class="source-grid">
        <div class="source-item">
          <div class="source-color" style="background:var(--primary);"></div>
          <div class="source-info">
            <div class="source-name">Direct Applications</div>
            <div class="source-count">156 applications</div>
          </div>
        </div>
        <div class="source-item">
          <div class="source-color" style="background:var(--accent-orange);"></div>
          <div class="source-info">
            <div class="source-name">Job Search</div>
            <div class="source-count">89 applications</div>
          </div>
        </div>
        <div class="source-item">
          <div class="source-color" style="background:#28a745;"></div>
          <div class="source-info">
            <div class="source-name">Referrals</div>
            <div class="source-count">45 applications</div>
          </div>
        </div>
        <div class="source-item">
          <div class="source-color" style="background:#6c757d;"></div>
          <div class="source-info">
            <div class="source-name">Social Media</div>
            <div class="source-count">23 applications</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Performing Jobs -->
    <div class="table-container">
      <div class="chart-header">
        <div class="chart-title">Top Performing Jobs</div>
      </div>
      <table class="analytics-table">
        <thead>
          <tr>
            <th>Job Title</th>
            <th>Category</th>
            <th>Views</th>
            <th>Applications</th>
            <th>Conversion Rate</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="topJobsTable">
          <tr>
            <td colspan="6" style="text-align:center;">Loading data...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Hiring Timeline -->
    <div class="chart-container">
      <div class="chart-header">
        <div class="chart-title">Hiring Timeline</div>
        <div class="chart-period">
          <button class="period-btn active">Last 30 Days</button>
        </div>
      </div>
      <div id="hiringTimeline">
        <!-- Timeline will be generated here -->
      </div>
    </div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    (function () {
      const user = getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      if (user.role !== "recruiter") {
        alert("Recruiter access only.");
        window.location.href = "../index.html";
        return;
      }

      document.getElementById("logoutBtn").addEventListener("click", logout);

      function esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[m]);
      }

      // Mock analytics data
      const analyticsData = {
        totalViews: 2847,
        totalApplications: 342,
        conversionRate: 12.0,
        timeToHire: 7,
        costPerHire: 2500,
        activeJobs: 8,
        topJobs: [
          {
            title: 'Security Guard',
            category: 'Security',
            views: 523,
            applications: 78,
            conversionRate: 14.9,
            status: 'active'
          },
          {
            title: 'Delivery Driver',
            category: 'Transport',
            views: 412,
            applications: 56,
            conversionRate: 13.6,
            status: 'active'
          },
          {
            title: 'Cook Assistant',
            category: 'Food Service',
            views: 389,
            applications: 45,
            conversionRate: 11.6,
            status: 'closed'
          }
        ],
        hiringEvents: [
          { date: '2024-02-20', candidate: 'Rahul Kumar', position: 'Security Guard', timeToHire: 5 },
          { date: '2024-02-18', candidate: 'Priya Sharma', position: 'Driver', timeToHire: 3 },
          { date: '2024-02-15', candidate: 'Amit Singh', position: 'Cook', timeToHire: 7 }
        ]
      };

      function updateMetrics() {
        document.getElementById('totalViews').textContent = analyticsData.totalViews.toLocaleString();
        document.getElementById('totalApplications').textContent = analyticsData.totalApplications.toLocaleString();
        document.getElementById('conversionRate').textContent = analyticsData.conversionRate.toFixed(1) + '%';
        document.getElementById('timeToHire').textContent = analyticsData.timeToHire + 'd';
        document.getElementById('costPerHire').textContent = '₹' + analyticsData.costPerHire.toLocaleString();
        document.getElementById('activeJobs').textContent = analyticsData.activeJobs;
      }

      function generatePerformanceChart() {
        const canvas = document.getElementById('jobChart');
        const ctx = canvas.getContext('2d');
        
        // Simple bar chart implementation
        const data = [65, 78, 90, 81, 56, 72, 88, 95];
        const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7', 'Week 8'];
        
        const maxValue = Math.max(...data);
        const chartWidth = canvas.width;
        const chartHeight = canvas.height;
        const barWidth = chartWidth / data.length * 0.7;
        const barSpacing = chartWidth / data.length * 0.3;
        
        // Clear canvas
        ctx.clearRect(0, 0, chartWidth, chartHeight);
        
        // Draw bars
        data.forEach((value, index) => {
          const barHeight = (value / maxValue) * (chartHeight - 40);
          const x = index * (barWidth + barSpacing) + barSpacing / 2;
          const y = chartHeight - barHeight - 20;
          
          // Draw bar
          ctx.fillStyle = '#004e92';
          ctx.fillRect(x, y, barWidth, barHeight);
          
          // Draw value
          ctx.fillStyle = '#333';
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(value, x + barWidth / 2, y - 5);
          
          // Draw label
          ctx.fillText(labels[index], x + barWidth / 2, chartHeight - 5);
        });
      }

      function generateTopJobsTable() {
        const tableBody = document.getElementById('topJobsTable');
        
        const rows = analyticsData.topJobs.map(job => `
          <tr>
            <td>${esc(job.title)}</td>
            <td>${esc(job.category)}</td>
            <td>${job.views.toLocaleString()}</td>
            <td>${job.applications.toLocaleString()}</td>
            <td>
              <div style="display:flex;align-items:center;gap:5px;">
                <span>${job.conversionRate.toFixed(1)}%</span>
                <div class="progress-bar" style="width:60px;">
                  <div class="progress-fill" style="width:${job.conversionRate * 5}%;"></div>
                </div>
              </div>
            </td>
            <td>
              <span style="background:${job.status === 'active' ? 'var(--action-green)' : 'var(--text-muted)'};color:white;padding:4px 8px;border-radius:12px;font-size:12px;">
                ${job.status.toUpperCase()}
              </span>
            </td>
          </tr>
        `).join('');
        
        tableBody.innerHTML = rows;
      }

      function generateHiringTimeline() {
        const timeline = document.getElementById('hiringTimeline');
        
        const timelineHTML = analyticsData.hiringEvents.map((event, index) => `
          <div style="display:flex;gap:15px;margin-bottom:15px;${index === 0 ? '' : 'opacity:0.7;'}">
            <div style="min-width:80px;text-align:right;color:var(--text-muted);font-size:12px;">
              ${event.date}
            </div>
            <div style="flex:1;background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid var(--primary);">
              <div style="font-weight:bold;margin-bottom:5px;">${esc(event.candidate)}</div>
              <div style="color:var(--text-muted);font-size:14px;">${esc(event.position)}</div>
              <div style="margin-top:5px;">
                <span style="background:var(--accent-orange);color:white;padding:2px 6px;border-radius:4px;font-size:11px;">
                  ${event.timeToHire} days to hire
                </span>
              </div>
            </div>
          </div>
        `).join('');
        
        timeline.innerHTML = timelineHTML;
      }

      // Period selection handlers
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          // In real implementation, this would reload data for the selected period
          console.log('Period changed to:', this.textContent);
        });
      });

      // Initialize all components
      updateMetrics();
      generatePerformanceChart();
      generateTopJobsTable();
      generateHiringTimeline();
    })();
  </script>

  <div data-include="footer"></div>
</body>
</html>
