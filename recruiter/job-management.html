<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Management - Recruiter</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .management-grid{display:grid;grid-template-columns:1fr 2fr;gap:20px;margin-top:20px}
    .sidebar{display:flex;flex-direction:column;gap:15px}
    .main-content{display:flex;flex-direction:column;gap:20px}
    .job-card{background:white;padding:15px;border-radius:8px;border-left:4px solid var(--primary);margin-bottom:15px}
    .job-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
    .job-title{font-weight:bold;font-size:18px}
    .job-meta{font-size:14px;color:var(--text-muted);margin:5px 0}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}
    .stat-card{background:var(--glass-bg);padding:15px;border-radius:8px;text-align:center}
    .stat-number{font-size:1.8rem;font-weight:900;color:var(--primary)}
    .stat-label{font-size:12px;color:var(--text-muted);margin-top:5px}
    .action-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .template-card{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;cursor:pointer}
    .template-card:hover{background:#e9ecef}
    .template-title{font-weight:bold;margin-bottom:5px}
    .template-preview{font-size:12px;color:var(--text-muted)}
    .bulk-actions{background:white;padding:15px;border-radius:8px;margin-bottom:20px}
    .filter-section{background:white;padding:15px;border-radius:8px;margin-bottom:20px}
    .filter-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .filter-row input, .filter-row select{padding:8px;border:1px solid #ddd;border-radius:6px}
    .performance-chart{background:white;padding:20px;border-radius:8px}
    .chart-bar{display:flex;align-items:end;height:200px;gap:10px}
    .bar{flex:1;background:var(--accent-orange);border-radius:4px 4px 0 0;position:relative}
    .bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:10px;white-space:nowrap}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="dashboard.html" class="btn">‚Üê Back</a>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Advanced Job Management</h1>
    <p class="meta mb-2">Manage your job postings with powerful tools and analytics</p>

    <!-- Statistics Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalJobs">0</div>
        <div class="stat-label">Total Jobs Posted</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeJobs">0</div>
        <div class="stat-label">Active Jobs</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalViews">0</div>
        <div class="stat-label">Total Views</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalApplications">0</div>
        <div class="stat-label">Total Applications</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="conversionRate">0%</div>
        <div class="stat-label">Application Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgTimeToHire">0d</div>
        <div class="stat-label">Avg. Time to Hire</div>
      </div>
    </div>

    <div class="management-grid">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Quick Actions -->
        <div class="bulk-actions">
          <h3 style="margin:0 0 15px;">Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn btn-primary" onclick="bulkPostJobs()">üìù Post Multiple Jobs</button>
            <button class="btn" onclick="duplicateJob()">üìã Duplicate Job</button>
            <button class="btn" onclick="exportJobs()">üìä Export Jobs</button>
            <button class="btn" onclick="importJobs()">üì• Import Jobs</button>
          </div>
        </div>

        <!-- Job Templates -->
        <div class="card">
          <h3 style="margin:0 0 15px;">Job Templates</h3>
          <div id="templatesList">
            <div class="template-card" onclick="useTemplate('security')">
              <div class="template-title">Security Guard</div>
              <div class="template-preview">Standard security position template</div>
            </div>
            <div class="template-card" onclick="useTemplate('driver')">
              <div class="template-title">Driver</div>
              <div class="template-preview">Transportation job template</div>
            </div>
            <div class="template-card" onclick="useTemplate('general')">
              <div class="template-title">General Worker</div>
              <div class="template-preview">Multi-purpose worker template</div>
            </div>
          </div>
          <button class="btn btn-primary" style="margin-top:10px;width:100%;" onclick="createTemplate()">+ Create Template</button>
        </div>

        <!-- Pricing Plans -->
        <div class="card">
          <h3 style="margin:0 0 15px;">Pricing Plans</h3>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="padding:10px;border:1px solid #ddd;border-radius:6px;">
              <div style="font-weight:bold;">Free Plan</div>
              <div style="font-size:12px;color:var(--text-muted);">3 active jobs</div>
            </div>
            <div style="padding:10px;border:2px solid var(--accent-orange);border-radius:6px;background:#fff8f0;">
              <div style="font-weight:bold;">Premium Plan</div>
              <div style="font-size:12px;color:var(--text-muted);">Unlimited jobs ‚Ä¢ Analytics</div>
              <button class="btn btn-primary" style="margin-top:5px;width:100%;">Upgrade</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Filters -->
        <div class="filter-section">
          <h3 style="margin:0 0 15px;">Filter Jobs</h3>
          <div class="filter-row">
            <input type="text" id="searchJobs" placeholder="Search jobs..." style="flex:1;">
            <select id="statusFilter">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="closed">Closed</option>
              <option value="expired">Expired</option>
            </select>
            <select id="categoryFilter">
              <option value="">All Categories</option>
              <option value="Security Guard">Security Guard</option>
              <option value="Driver">Driver</option>
              <option value="Cook">Cook</option>
              <option value="General Worker">General Worker</option>
            </select>
            <button class="btn" onclick="applyFilters()">Apply</button>
          </div>
        </div>

        <!-- Jobs List -->
        <div id="jobsList">
          <p class="meta">Loading jobs...</p>
        </div>

        <!-- Performance Chart -->
        <div class="performance-chart">
          <h3 style="margin:0 0 15px;">Job Performance</h3>
          <div class="chart-bar" id="performanceChart">
            <!-- Chart will be generated here -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    (function () {
      const user = getUser();

      if (!user) {
        window.location.href = "login.html";
        return;
      }

      if (user.role !== "recruiter") {
        alert("Recruiter access only.");
        window.location.href = "../index.html";
        return;
      }

      document.getElementById("logoutBtn").addEventListener("click", logout);

      let jobs = [];
      let filteredJobs = [];

      function esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        })[m]);
      }

      function formatDate(date) {
        return new Date(date).toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
      }

      function jobCard(job) {
        const statusColor = job.status === 'active' ? 'var(--action-green)' : 
                           job.status === 'closed' ? 'var(--text-muted)' : 'var(--accent-orange)';
        
        return `
          <div class="job-card">
            <div class="job-header">
              <div>
                <div class="job-title">${esc(job.title)}</div>
                <div class="job-meta">${esc(job.company)} ‚Ä¢ ${esc(job.location)}</div>
                <div class="job-meta">Posted: ${formatDate(job.created_at)}</div>
              </div>
              <div style="text-align:right;">
                <span style="background:${statusColor};color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold;">
                  ${job.status.toUpperCase()}
                </span>
              </div>
            </div>
            <div class="job-meta">
              <strong>Views:</strong> ${job.views || 0} ‚Ä¢ 
              <strong>Applications:</strong> ${job.application_count || 0} ‚Ä¢ 
              <strong>Conversion:</strong> ${job.views ? Math.round((job.application_count / job.views) * 100) : 0}%
            </div>
            <div class="action-buttons">
              <button class="btn btn-primary" onclick="editJob(${job.id})">‚úèÔ∏è Edit</button>
              <button class="btn" onclick="duplicateJob(${job.id})">üìã Duplicate</button>
              <button class="btn" onclick="viewApplications(${job.id})">üë• Applications</button>
              <button class="btn" onclick="viewAnalytics(${job.id})">üìä Analytics</button>
              ${job.status === 'active' ? 
                `<button class="btn" onclick="updateJobStatus(${job.id}, 'closed')">üîí Close</button>` :
                `<button class="btn" onclick="updateJobStatus(${job.id}, 'active')">‚úÖ Activate</button>`
              }
              <button class="btn" onclick="deleteJob(${job.id})">üóëÔ∏è Delete</button>
            </div>
          </div>
        `;
      }

      function loadJobs() {
        // Mock job data
        jobs = [
          {
            id: 1,
            title: 'Senior Security Guard',
            company: 'ABC Security',
            location: 'Mumbai',
            status: 'active',
            created_at: new Date(Date.now() - 86400000 * 10).toISOString(),
            views: 245,
            application_count: 18
          },
          {
            id: 2,
            title: 'Delivery Driver',
            company: 'XYZ Logistics',
            location: 'Delhi',
            status: 'active',
            created_at: new Date(Date.now() - 86400000 * 5).toISOString(),
            views: 189,
            application_count: 12
          },
          {
            id: 3,
            title: 'Cook Assistant',
            company: 'Food Court',
            location: 'Bangalore',
            status: 'closed',
            created_at: new Date(Date.now() - 86400000 * 15).toISOString(),
            views: 156,
            application_count: 8
          }
        ];

        filteredJobs = [...jobs];
        updateStatistics();
        renderJobs();
        generatePerformanceChart();
      }

      function updateStatistics() {
        const totalJobs = jobs.length;
        const activeJobs = jobs.filter(job => job.status === 'active').length;
        const totalViews = jobs.reduce((sum, job) => sum + (job.views || 0), 0);
        const totalApplications = jobs.reduce((sum, job) => sum + (job.application_count || 0), 0);
        const conversionRate = totalViews > 0 ? Math.round((totalApplications / totalViews) * 100) : 0;

        document.getElementById('totalJobs').textContent = totalJobs;
        document.getElementById('activeJobs').textContent = activeJobs;
        document.getElementById('totalViews').textContent = totalViews;
        document.getElementById('totalApplications').textContent = totalApplications;
        document.getElementById('conversionRate').textContent = conversionRate + '%';
        document.getElementById('avgTimeToHire').textContent = '7d'; // Mock data
      }

      function renderJobs() {
        const jobsList = document.getElementById('jobsList');
        if (filteredJobs.length === 0) {
          jobsList.innerHTML = '<p class="meta">No jobs found matching your criteria.</p>';
        } else {
          jobsList.innerHTML = filteredJobs.map(jobCard).join('');
        }
      }

      function generatePerformanceChart() {
        const chartContainer = document.getElementById('performanceChart');
        const jobPerformance = jobs.map(job => ({
          title: job.title.substring(0, 10) + '...',
          views: job.views || 0,
          applications: job.application_count || 0
        }));

        const maxViews = Math.max(...jobPerformance.map(j => j.views));
        
        const chartHTML = jobPerformance.map((job, index) => `
          <div class="bar" style="height:${(job.views / maxViews) * 180}px;position:relative;">
            <div class="bar-label">${job.title}</div>
          </div>
        `).join('');

        chartContainer.innerHTML = chartHTML;
      }

      function applyFilters() {
        const searchTerm = document.getElementById('searchJobs').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;

        filteredJobs = jobs.filter(job => {
          const matchesSearch = !searchTerm || 
            job.title.toLowerCase().includes(searchTerm) ||
            job.company.toLowerCase().includes(searchTerm) ||
            job.location.toLowerCase().includes(searchTerm);
          
          const matchesStatus = !statusFilter || job.status === statusFilter;
          const matchesCategory = !categoryFilter || job.category === categoryFilter;

          return matchesSearch && matchesStatus && matchesCategory;
        });

        renderJobs();
      }

      function bulkPostJobs() {
        alert('Bulk job posting feature:\n\n1. Upload CSV file with job details\n2. Review and edit each job\n3. Post all jobs at once\n\nFeature coming soon!');
      }

      function duplicateJob(jobId) {
        const job = jobs.find(j => j.id === jobId);
        if (job) {
          alert(`Duplicating job: ${job.title}\n\nThis will create a copy with same details that you can edit.`);
        }
      }

      function exportJobs() {
        alert('Export jobs to CSV/Excel format with all job details and analytics.');
      }

      function importJobs() {
        alert('Import jobs from CSV file. Supported format:\nTitle, Company, Location, Category, Description, Requirements');
      }

      function useTemplate(templateType) {
        const templates = {
          security: {
            title: 'Security Guard',
            category: 'Security Guard',
            description: 'Looking for experienced security personnel...',
            requirements: 'Must have security license and experience'
          },
          driver: {
            title: 'Driver',
            category: 'Driver',
            description: 'Seeking reliable driver for transportation services...',
            requirements: 'Valid driving license and clean record required'
          },
          general: {
            title: 'General Worker',
            category: 'General Worker',
            description: 'Looking for versatile worker for various tasks...',
            requirements: 'Hardworking and reliable individual needed'
          }
        };

        const template = templates[templateType];
        if (template) {
          alert(`Using ${template.title} template:\n\nPre-filled with standard requirements and description.\nYou can customize before posting.`);
        }
      }

      function createTemplate() {
        alert('Create custom job template:\n\nSave frequently used job descriptions, requirements, and settings for quick posting.');
      }

      function editJob(jobId) {
        alert(`Edit job functionality for job ID: ${jobId}`);
      }

      function viewApplications(jobId) {
        window.location.href = `applications.html?job_id=${jobId}`;
      }

      function viewAnalytics(jobId) {
        alert(`Detailed analytics for job ID: ${jobId}\n\nViews, applications, conversion rates, and more.`);
      }

      function updateJobStatus(jobId, newStatus) {
        if (confirm(`Change job status to ${newStatus}?`)) {
          alert(`Job ${jobId} status updated to ${newStatus}`);
          loadJobs(); // Reload to show updated status
        }
      }

      function deleteJob(jobId) {
        if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
          alert(`Job ${jobId} deleted successfully`);
          loadJobs(); // Reload to show updated list
        }
      }

      // Event listeners
      document.getElementById('searchJobs').addEventListener('input', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);

      // Initialize
      loadJobs();
    })();
  </script>

  <div data-include="footer"></div>
</body>
</html>
