<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Applications - Recruiter</title>
  <link rel="stylesheet" href="../styles-new.css" />
  <style>
    .app-card{padding:14px}
    .app-name{font-size:20px;font-weight:900;margin:0 0 6px}
    .app-meta{margin:4px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div class="row">
      <a class="btn" href="dashboard.html">‚Üê Back</a>
      <button class="btn" id="logoutBtn" type="button">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Applications</h1>
    <p class="meta" id="sub">Loading...</p>

    <div id="appsBox" class="grid" style="margin-top:14px;"></div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/partials-unified.js"></script>

  <script>
    const user = requireLogin("recruiter/dashboard.html");
    if (user && user.role !== "recruiter") {
      alert("Recruiter access only.");
      window.location.href = "../index.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", logout);

    const jobId = new URLSearchParams(location.search).get("job_id");

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function digitsOnly(s){ return String(s||"").replace(/\D/g,""); }

    function appCard(a){
      const phoneDigits = digitsOnly(a.applicant_phone);
      const callBtn = phoneDigits
        ? `<a class="btn btn-primary" href="tel:${phoneDigits}">üìû Call</a>`
        : "";

      const waBtn = phoneDigits
        ? `<a class="btn" target="_blank" href="https://wa.me/91${phoneDigits}">WhatsApp</a>`
        : "";

      return `
        <div class="card app-card">
          <div class="app-name">${esc(a.applicant_name)}</div>
          <div class="app-meta"><strong>Phone:</strong> ${esc(a.applicant_phone)}</div>
          ${a.applicant_email ? `<div class="app-meta"><strong>Email:</strong> ${esc(a.applicant_email)}</div>` : ""}
          ${a.message ? `<div class="app-meta"><strong>Message:</strong> ${esc(a.message)}</div>` : ""}
          <div class="row" style="margin-top:10px;">
            ${callBtn}
            ${waBtn}
          </div>
        </div>
      `;
    }

    async function loadApplications(){
      const sub = document.getElementById("sub");
      const box = document.getElementById("appsBox");

      if (!jobId){
        sub.textContent = "No job selected.";
        return;
      }

      sub.textContent = "Loading applications...";
      box.innerHTML = "";

      try{
        console.log('Loading applications for job_id:', jobId);
        
        // Fetch applications for this specific job
        const url = API("applications_list.php") + `?job_id=${encodeURIComponent(jobId)}`;
        console.log('Fetching from URL:', url);
        
        const res = await fetch(url);
        const responseText = await res.text();
        console.log('Raw response:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseErr) {
          console.error('Failed to parse JSON:', parseErr);
          sub.textContent = "Server error: Invalid response format.";
          return;
        }
        
        console.log('Parsed data:', data);

        if(!data.ok){
          console.error('API returned not ok:', data);
          sub.textContent = data.message || "Failed to load applications.";
          return;
        }

        const apps = data.applications || [];
        console.log('Applications found:', apps.length);
        console.log('Applications data:', apps);
        
        if(apps.length === 0){
          sub.textContent = "No applications yet for this job.";
          return;
        }

        sub.textContent = `Total applications: ${apps.length}`;
        
        console.log('Raw applications data:', apps);
        console.log('First application details:', apps[0]);
        
        // Create application cards with user details
        const appCards = apps.map(app => {
          console.log('Processing application:', app);
          console.log('Application applicant_name:', app.applicant_name);
          console.log('Application applicant_phone:', app.applicant_phone);
          console.log('Application message:', app.message);
          
          // Get user details from the nested user object
          const userName = app.user ? app.user.name : 'Unknown';
          const userEmail = app.user ? app.user.email : '';
          const userPhone = app.user ? app.user.phone : '';
          
          // Get applicant details from application (if available)
          const applicantName = app.applicant_name || userName;
          const applicantPhone = app.applicant_phone || userPhone;
          const applicantEmail = app.applicant_email || userEmail;
          const applicantMessage = app.message || '';
          
          console.log('Final applicant details:', {
            name: applicantName,
            phone: applicantPhone,
            email: applicantEmail,
            message: applicantMessage,
            userProfile: app.user
          });
          
          const phoneDigits = digitsOnly(applicantPhone);
          const callBtn = phoneDigits
            ? `<a class="btn btn-primary" href="tel:${phoneDigits}">üìû Call</a>`
            : "";

          const waBtn = phoneDigits
            ? `<a class="btn" target="_blank" href="https://wa.me/91${phoneDigits}">WhatsApp</a>`
            : "";

          return `
            <div class="card app-card">
              <div class="app-name">${esc(applicantName)}</div>
              ${applicantPhone ? `<div class="app-meta"><strong>Phone:</strong> ${esc(applicantPhone)}</div>` : ""}
              ${applicantEmail ? `<div class="app-meta"><strong>Email:</strong> ${esc(applicantEmail)}</div>` : ""}
              ${applicantMessage ? `<div class="app-meta"><strong>Message:</strong> ${esc(applicantMessage)}</div>` : ""}
              <div class="app-meta"><strong>Applied:</strong> ${new Date(app.applied_at).toLocaleDateString()}</div>
              ${applicantPhone ? `<div class="row" style="margin-top:10px;">${callBtn} ${waBtn}</div>` : ""}
            </div>
          `;
        }).join("");
        
        box.innerHTML = appCards;
        console.log('Applications rendered successfully');
        
      }catch(e){
        console.error('Load applications error:', e);
        sub.textContent = "Server error. Please try again.";
      }
    }

    loadApplications();
  </script>

  <div data-include="footer"></div>
</body>
</html>
</html>
